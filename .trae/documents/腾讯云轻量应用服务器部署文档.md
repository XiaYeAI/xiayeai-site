# 腾讯云轻量应用服务器部署文档

## 1. 服务器环境概述

### 1.1 基础环境
- **操作系统**: Linux (腾讯云轻量应用服务器)
- **Web 服务器**: Nginx 1.26.3
- **管理面板**: 宝塔面板
- **防火墙**: 已启用 (running)
- **开放端口**: 80, 443, 8080, 8073

### 1.2 当前配置状态
- **文档根目录**: `/www/wwwroot`
- **Nginx 配置目录**: `/etc/nginx/conf.d/`
- **现有子域名**: api.md2xhs.xiayeai.cn, md2xhs.xiayeai.cn, devapi.md2xhs.xiayeai.cn, kf.xiayeai.cn
- **SSL 证书**: 已为部分子域名配置
- **默认站点**: 当前监听所有未配置的域名

## 2. 部署前准备

### 2.1 DNS 配置确认
- ✅ 确认 `www.xiayeai.cn` 的 A 记录已添加并指向服务器 IP
- 等待 DNS 解析生效（通常 10-30 分钟）

### 2.2 备份准备
- 由于用户确认无需保留 WordPress，跳过备份步骤
- 建议备份当前 Nginx 配置文件（可选）

### 2.3 本地环境准备
- 确保本地项目可正常运行
- 检查 `.env.production` 文件配置
- 验证 Supabase 连接配置正确

## 3. 详细部署步骤

### 3.1 本地项目构建

#### 步骤 1: 创建生产环境配置
```bash
# 在项目根目录创建 .env.production 文件
echo "VITE_SUPABASE_URL=https://your-project.supabase.co" > .env.production
echo "VITE_SUPABASE_ANON_KEY=your-anon-key" >> .env.production
```

#### 步骤 2: 执行构建命令
```bash
npm run build
```

#### 步骤 3: 验证构建产物
- 确认 `dist` 目录生成成功
- 检查 `dist/index.html` 文件存在
- 验证静态资源文件完整

### 3.2 通过宝塔面板部署

#### 步骤 1: 登录宝塔面板
1. 访问宝塔面板地址
2. 使用管理员账号登录

#### 步骤 2: 创建新站点
1. 进入「网站」管理页面
2. 点击「添加站点」
3. 填写站点信息：
   - **域名**: `www.xiayeai.cn`
   - **根目录**: `/www/wwwroot/xiayeai.cn`
   - **PHP版本**: 选择「纯静态」
   - **数据库**: 不创建
4. 点击「提交」创建站点

#### 步骤 3: 上传构建产物
1. 进入「文件」管理页面
2. 导航到 `/www/wwwroot/xiayeai.cn` 目录
3. 删除默认的 `index.html` 文件
4. 上传本地 `dist` 目录中的所有文件
   - 可使用宝塔面板的文件上传功能
   - 或通过 SFTP 工具上传

### 3.3 Nginx 配置优化

#### 步骤 1: 配置前端路由回退
1. 在宝塔面板中进入「网站」→「设置」→「配置文件」
2. 添加以下配置：

```nginx
server {
    listen 80;
    server_name www.xiayeai.cn;
    root /www/wwwroot/xiayeai.cn;
    index index.html;
    
    # 前端路由回退配置
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存配置
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # 安全头配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
}
```

#### 步骤 2: 域名规范化（可选）
如需将 `xiayeai.cn` 重定向到 `www.xiayeai.cn`：

```nginx
server {
    listen 80;
    server_name xiayeai.cn;
    return 301 https://www.xiayeai.cn$request_uri;
}
```

### 3.4 HTTPS 证书配置

#### 步骤 1: 申请 SSL 证书
1. 在宝塔面板中进入「网站」→「设置」→「SSL」
2. 选择「Let's Encrypt」免费证书
3. 填写域名：`www.xiayeai.cn`
4. 点击「申请」

#### 步骤 2: 启用强制 HTTPS
1. 证书申请成功后，开启「强制HTTPS」
2. 验证 HTTPS 访问正常

## 4. Supabase 配置检查

### 4.1 环境变量验证
确认生产环境配置正确：
- `VITE_SUPABASE_URL`: Supabase 项目 URL
- `VITE_SUPABASE_ANON_KEY`: 匿名访问密钥

### 4.2 数据库连接测试
1. 访问部署后的网站
2. 检查首页数据加载是否正常
3. 测试管理员登录功能

## 5. 验证和测试步骤

### 5.1 基础功能验证
- [ ] 访问 `https://www.xiayeai.cn` 正常加载
- [ ] 首页文章列表显示正常
- [ ] 导航菜单功能正常
- [ ] 文章详情页可正常访问
- [ ] 关于页面、联系页面正常

### 5.2 管理员功能验证
- [ ] 管理员登录功能正常
- [ ] 文章管理（增删改查）功能正常
- [ ] 社交平台管理功能正常
- [ ] 统计数据显示正常

### 5.3 性能和安全验证
- [ ] 页面加载速度正常（< 3秒）
- [ ] 移动端适配正常
- [ ] HTTPS 证书有效
- [ ] 安全头配置生效

## 6. 常见问题排查

### 6.1 构建失败
**问题**: `npm run build` 执行失败
**解决方案**:
1. 检查 TypeScript 类型错误
2. 确认所有依赖已正确安装
3. 检查环境变量配置
4. 查看具体错误信息并修复

### 6.2 页面无法访问
**问题**: 部署后页面显示 404 或无法访问
**解决方案**:
1. 检查 DNS 解析是否生效
2. 确认 Nginx 配置正确
3. 验证文件上传完整性
4. 检查防火墙端口开放

### 6.3 前端路由问题
**问题**: 直接访问子路径返回 404
**解决方案**:
1. 确认 Nginx 配置中包含 `try_files $uri $uri/ /index.html;`
2. 重启 Nginx 服务
3. 清除浏览器缓存

### 6.4 API 连接失败
**问题**: 前端无法连接 Supabase
**解决方案**:
1. 检查 `.env.production` 配置
2. 确认 Supabase 项目状态正常
3. 验证网络连接
4. 检查浏览器控制台错误信息

### 6.5 HTTPS 证书问题
**问题**: SSL 证书申请失败或无效
**解决方案**:
1. 确认域名解析正确指向服务器
2. 检查防火墙 80/443 端口开放
3. 重新申请证书
4. 联系宝塔技术支持

## 7. 回滚方案

### 7.1 快速回滚步骤
如果部署出现问题，可按以下步骤快速回滚：

1. **停用新站点**:
   - 在宝塔面板中停用 `www.xiayeai.cn` 站点
   - 或修改 Nginx 配置临时禁用

2. **恢复默认页面**:
   - 在站点根目录放置临时维护页面
   - 显示"网站维护中"信息

3. **DNS 切换**（如有备用方案）:
   - 将域名解析切换到备用服务器
   - 等待 DNS 生效

### 7.2 数据恢复
- Supabase 数据无需恢复（云端托管）
- 如有本地备份，可重新上传文件

## 8. 部署后维护

### 8.1 定期检查项目
- 每周检查网站访问状态
- 监控 SSL 证书到期时间
- 定期更新 Nginx 和系统安全补丁

### 8.2 性能优化建议
- 启用 CDN 加速（可选）
- 配置更精细的缓存策略
- 监控网站性能指标

### 8.3 安全维护
- 定期更新宝塔面板
- 监控异常访问日志
- 保持 Supabase 安全配置最新

---

**部署完成检查清单**:
- [ ] 域名解析配置正确
- [ ] 网站文件上传完整
- [ ] Nginx 配置优化完成
- [ ] HTTPS 证书申请成功
- [ ] 基础功能验证通过
- [ ] 管理员功能验证通过
- [ ] 性能和安全检查完成

**联系信息**:
如在部署过程中遇到问题，可参考本文档的常见问题排查部分，或联系技术支持。