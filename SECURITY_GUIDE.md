# Supabase 安全指南

## 🚨 重要安全修复记录

**日期**: 2025-01-13  
**问题**: Service Role Key 暴露在前端环境变量中  
**状态**: ✅ 已修复

## 密钥类型说明

### 1. ANON_KEY (匿名密钥)
- **用途**: 前端应用安全使用
- **权限**: 受 RLS (Row Level Security) 策略限制
- **安全性**: 可以安全地暴露在前端代码中
- **当前状态**: ✅ 正常使用

### 2. SERVICE_ROLE_KEY (服务角色密钥)
- **用途**: 后端服务器端操作
- **权限**: 绕过所有 RLS 策略，拥有完全数据库访问权限
- **安全性**: ⚠️ 绝对不能暴露在前端
- **当前状态**: ✅ 已从前端移除

## 已执行的安全措施

1. **移除危险密钥**: 从 `.env` 文件中删除 `VITE_SUPABASE_SERVICE_ROLE_KEY`
2. **保留安全密钥**: 仅保留前端安全的 `VITE_SUPABASE_ANON_KEY`
3. **测试文件处理**: 测试文件中的 Service Role Key 使用是合理的（仅用于测试环境）

## 后续安全建议

### 立即执行 (高优先级)

1. **密钥轮换**
   ```bash
   # 在 Supabase Dashboard 中:
   # 1. 进入 Settings > API
   # 2. 点击 "Reset" 重新生成 Service Role Key
   # 3. 更新服务器端配置（如果有后端服务）
   ```

2. **检查 Git 历史**
   ```bash
   # 检查是否有密钥被提交到版本控制
   git log --all --grep="SERVICE_ROLE_KEY" -p
   git log --all -S "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" -p
   ```

3. **更新 .gitignore**
   ```
   # 确保包含以下内容
   .env
   .env.local
   .env.*.local
   ```

### 中期优化 (中优先级)

1. **环境变量分离**
   - 创建 `.env.example` 模板文件
   - 区分开发、测试、生产环境配置

2. **RLS 策略审查**
   - 确保所有表都启用了 RLS
   - 验证策略覆盖所有必要的访问控制

3. **监控设置**
   - 在 Supabase Dashboard 中启用 API 使用监控
   - 设置异常访问告警

### 长期维护 (低优先级)

1. **定期密钥轮换**
   - 建议每 3-6 个月轮换一次密钥
   - 建立密钥管理流程

2. **安全审计**
   - 定期检查环境变量配置
   - 审查数据库访问日志

## 测试环境说明

当前项目中的测试文件 (`test/` 目录) 使用 Service Role Key 是合理的，因为：
- 测试需要完整的数据库访问权限
- 测试文件不会被打包到生产环境
- 测试环境应该与生产环境隔离

## 应急联系

如果发现其他安全问题，请立即：
1. 停止相关服务
2. 评估影响范围
3. 执行必要的安全措施
4. 记录处理过程

---

**最后更新**: 2025-01-13  
**负责人**: SOLO Coding  
**状态**: 安全风险已解决